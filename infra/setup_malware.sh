#!/bin/bash
set -e

echo "[*] Entering Malware Directory..."
cd /app/attack_tools/AI-malware

# 1. PATCH THE MALWARE TO HIT OUR PROXY
# We find the hardcoded Meta URL in the malware's api package and replace it.
# The Proxy is listening on port 8080
echo "[*] Patching Malware to talk to LLM Proxy..."
PROXY_URL="http://llm_proxy:8080/v1/proxy"

# Patch all occurrences of Meta AI URLs
find . -type f -name "*.go" -exec sed -i "s|https://www.meta.ai/api/graphql/|${PROXY_URL}|g" {} +
find . -type f -name "*.go" -exec sed -i "s|https://graph.meta.ai/graphql|${PROXY_URL}|g" {} +

# Verify patching worked
echo "[*] Verifying URL patching..."
if grep -r "https://www.meta.ai" . --include="*.go" | grep -v "GetCookiesWithClient\|GetFbSession" > /dev/null; then
    echo "[!] WARNING: Some Meta AI URLs may not have been patched"
    grep -r "https://www.meta.ai" . --include="*.go" | head -5
else
    echo "[+] URL patching verified successfully"
fi

# 2. Build the binary
echo "[*] Compiling AI-Malware..."
go mod tidy
go build -o malware_gen ai-malware.go

if [ -f "./malware_gen" ]; then
    echo "[+] Build Success! Malware binary created."
    echo "[*] All API calls will be intercepted by BlueFlux proxy at ${PROXY_URL}"
else
    echo "[!] Build Failed. Check logs."
    exit 1
fi

# 3. Run the Python Controller (which executes the binary)
echo "[*] Starting attack simulation..."
export PYTHONUNBUFFERED=1
python3 /app/attack_scenarios/fallback_attacker.py